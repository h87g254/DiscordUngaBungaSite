@model ApplicationMessage.Models.HomeViewModel

@{
    ViewData["Title"] = "Home";
}

<div class="container">

    <!-- Friends -->
    <div class="card">
        <h2 style="margin-bottom: 1rem;">Friends</h2>
        @if (Model.Friends != null && Model.Friends.Any())
        {
            @foreach (var friend in Model.Friends)
            {
                var online = (DateTime.UtcNow - friend.LastSeen).TotalMinutes < 5;
                <div class="user-card">
                    <div class="status-wrapper @(online ? "online" : "offline")">
                        <img src="@(friend.ProfilePicturePath ?? "/images/default-avatar.png")" alt="Profile" />
                        <span class="status-dot"></span>
                    </div>
                    <span>@friend.Username</span>

                    <form method="get" asp-controller="Messages" asp-action="Chat">
                        <input type="hidden" name="userId" value="@friend.Id" />
                        <button type="submit">Chat</button>
                    </form>

                    <form method="post" asp-action="RemoveFriend">
                        <input type="hidden" name="friendId" value="@friend.Id" />
                        <button type="submit">Remove</button>
                    </form>
                </div>
            }
        }
        else
        {
            <p>No friends yet.</p>
        }
    </div>

    <!-- Rooms -->
    <div class="card">
        <h2>My Groups / Rooms</h2>
        @if (ViewBag.MyRooms != null && ViewBag.MyRooms.Count > 0)
        {
            foreach (var room in ViewBag.MyRooms)
            {
                <div class="user-card">
                    <span style="font-weight: 600;">@room.RoomName</span>
                    <form method="get" asp-controller="Messages" asp-action="RoomChat">
                        <input type="hidden" name="roomId" value="@room.Id" />
                        <button type="submit">Enter</button>
                    </form>
                </div>
            }
        }
        else
        {
            <p>You are not in any rooms yet. <a href="/Rooms/Index">Find or create rooms</a>.</p>
        }
    </div>


    <!-- Pending Requests -->
    <div class="card">
        <h2 style="margin-bottom: 1rem;">Pending Friend Requests</h2>
        @if (Model.PendingRequests != null && Model.PendingRequests.Any())
        {
            @foreach (var request in Model.PendingRequests)
            {
                var user = request.Requester;
                var online = (DateTime.UtcNow - user.LastSeen).TotalMinutes < 5;
                <div class="user-card">
                    <div class="status-wrapper @(online ? "online" : "offline")">
                        <img src="@(user.ProfilePicturePath ?? "/images/default-avatar.png")" alt="Profile" />
                        <span class="status-dot"></span>
                    </div>
                    <span>@user.Username</span>

                    <form method="post" asp-action="AcceptFriend">
                        <input type="hidden" name="friendshipId" value="@request.Id" />
                        <button type="submit">Accept</button>
                    </form>
                </div>
            }
        }
        else
        {
            <p>No pending requests.</p>
        }
    </div>

    <div class="card">
        <h2>Pending Room Invites</h2>
        @if (ViewBag.PendingRoomInvites != null && ViewBag.PendingRoomInvites.Count > 0)
        {
            foreach (var invite in ViewBag.PendingRoomInvites)
            {
                <div>
                    <span>Invite to @invite.Room.RoomName</span>
                    <form method="post" asp-action="AcceptRoomInvite">
                        <input type="hidden" name="inviteId" value="@invite.Id" />
                        <button type="submit">Accept</button>
                    </form>
                </div>
            }
        }
        else
        {
            <p>No pending room invites.</p>
        }
    </div>


    <!-- Search bar -->
    <div class="card">
        <form method="get" asp-action="Index">
            <input type="text" name="search" placeholder="Search users..." value="@(Context.Request.Query["search"])" />
            <button type="submit">Search</button>
        </form>
    </div>

    <!-- Search Results -->
    <div class="card">
        <h2 style="margin-bottom: 1rem;">
            @(string.IsNullOrEmpty(Context.Request.Query["search"]) ? "All Users" : "Search Results")
        </h2>
        @if (Model.AllUsers != null && Model.AllUsers.Any())
        {
            @foreach (var user in Model.AllUsers)
            {
                var online = (DateTime.UtcNow - user.LastSeen).TotalMinutes < 5;
                <div class="user-card">
                    <div class="status-wrapper @(online ? "online" : "offline")">
                        <img src="@(user.ProfilePicturePath ?? "/images/default-avatar.png")" alt="Profile" />
                        <span class="status-dot"></span>
                    </div>
                    <span>@user.Username</span>

                    <form method="post" asp-action="AddFriend">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <button type="submit">Add Friend</button>
                    </form>
                </div>
            }
        }
        else
        {
            <p>No users found.</p>
        }
    </div>
</div>
